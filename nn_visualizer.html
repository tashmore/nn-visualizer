<meta charset="UTF-8">
<html>
<head>
    <title>Neural Net Visualizer</title>
    <script src="http://d3js.org/d3.v3.min.js"></script>
    <script src="nn.js"></script>
    <style type="text/css">
        #net {
            margin: 0 auto;
            text-align: center;
        }

        .node {
            stroke: black;
            stroke-width: 4;
        }

        .node.hl {
            stroke: red;
        }
    </style>
</head>

<body>
    <h1>Neural Net Visualizer</h1>
    <code>
     <div style="width:100%">
         <div id='input'></div>
         <div id='net'></div>
         <div id='output'></div>
         <div style="width:100%" id='bottom'>
             Selected node value: <span id='selectedValue'>none</span>
             <div>
             <button onclick="javascript:gradientAscent()">Gradient Ascent</button>
             <button onclick="javascript:gradientDescent()">Gradient Descent</button>
             </div>
         </div>
     </div>
</code>

    <script type="text/javascript">
        var svg;
        var selectedNode;

        function initCanvas() {
            svg = d3.select('#net').append("svg")
                                      .attr("width", 800)
                                      .attr("height", 600)
                                      .attr("class", "chart")
                svg.append("g").attr("id", "edges")
                svg.append("g").attr("id", "nodes")
        }

        function drawNN(weights, input) {
            drawNodes(svg, feedForward(weights, input))
            var nodeData = d3.selectAll('.layer').data()
            drawEdges(svg, weights, nodeData)
        }

        function drawEdges(svg, weights, nodeData) {
            function getEdgeData(fromLayer, fromNode, toNode, weight) {
                var fromNode = nodeData[fromLayer][fromNode]
                var toNode = nodeData[fromLayer + 1][toNode]

                var padding = 5

                return {x1: fromNode.x + fromNode.width - padding,
                        y1: fromNode.y + fromNode.height/2,
                        x2: toNode.x + padding,
                        y2: toNode.y + toNode.height/2,
                        weight: weight}
            }

            var data = []
            for (var i=0; i<weights.length; i++) {
                for (var j=0; j<weights[i].length; j++) {
                    for (var k=0; k<weights[i][j].length; k++) {
                        data.push(getEdgeData(i, j, k, weights[i][j][k]))
                    }
                }
            }

            svg.select('#edges').selectAll('.edge')
                            .data(data)
                          .enter().append('svg:line')
                            .attr('class', 'edge')
                            .attr("x1", function(d) { return d.x1; })
                            .attr("y1", function(d) { return d.y1; })
                            .attr("x2", function(d) { return d.x2; })
                            .attr("y2", function(d) { return d.y2; })
                            .style('stroke-width', function(d) { return 5 * Math.abs(d.weight) })
                            .style('stroke', function(d) { return d.weight > 0 ? 'blue' : 'red' })
        }

        function setSelected(sel) {
            if (selectedNode)
                selectedNode.classed('hl', false)
            selectedNode = sel
            selectedNode.classed('hl', true)
            d3.select('#selectedValue').text(selectedNode.data()[0].value)
        }

        function drawNodes(svg, nodeValues) {
            function getNodeData(layerIdx, nodeIdx, value) {
                var originX = 10
                var originY = 10
                var width = 100
                var height = 100
                var wPadding = 200
                var hPadding = 30
                return {x: originX + layerIdx * (width + wPadding),
                        y: originY + nodeIdx * (height + hPadding),
                        width: width,
                        height: height,
                        value: nodeValues[layerIdx][nodeIdx]}
            }

            var data = []
            for (var i=0; i<nodeValues.length; i++) {
                data.push([])
                for (var j=0; j<nodeValues[i].length; j++) {
                    data[i].push(getNodeData(i, j))
                }
            }

            var layer = svg.select('#nodes').selectAll(".layer")
                           .data(data)
            layer.enter().append("svg:g")
                           .attr("class", "layer")

            var nodes = layer.selectAll(".node")
                             .data(function (d) { return d; })
            nodes.enter().append("svg:rect")
                 .attr("class", "node")
                 .on('click', function() { setSelected(d3.select(this)) })
            nodes.attr("x", function(d) { return d.x; })
                 .attr("y", function(d) { return d.y; })
                 .attr('rx', 10)
                 .attr('ry', 10)
                 .attr("width", function(d) { return d.width; })
                 .attr("height", function(d) { return d.height; })
                 .style("fill", function(d) { var v = Math.floor(255 * (1 - d.value)); return "rgb("+v+","+v+","+v+")" })
                 .append("svg:title")
                 .text(function(d) { return d.value; })
        }

        var weights = [
              [ [.4, -.5], [.001, 2.3], [-.1, .2], [.3, .4] ],
              [ [1.2], [-1.2], [-0.1] ]
            ]
        var input = [.1, .2, .3, 1]
        
        initCanvas()
        drawNN(weights, input)
    </script>
</body>
</html>